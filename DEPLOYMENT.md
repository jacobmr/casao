# Deployment Guide

## Vercel Environment Variables

Make sure these are set in Vercel dashboard:

### Required:
- `GUESTY_CLIENT_ID` - Your Guesty OAuth client ID
- `GUESTY_CLIENT_SECRET` - Your Guesty OAuth client secret
- `GUESTY_PROPERTY_ID` - Your property ID (688a8aae483ff0001243e891)
- `CRON_SECRET` - Random secret for cron job authentication (generate with: `openssl rand -base64 32`)

### Optional:
- `GUESTY_OAUTH_TOKEN_URL` - Default: https://booking.guesty.com/oauth2/token
- `GUESTY_OAUTH_SCOPE` - Default: booking_engine:api

## Cron Job Setup

The cron job is configured in `vercel.json`:
- **Schedule:** Daily at 2 AM UTC
- **Endpoint:** `/api/cron/cache-refresh`
- **Action:** Refreshes availability and pricing cache for 6 months

## To Deploy:

1. **Set environment variables** in Vercel dashboard:
   ```
   https://vercel.com/huddlehealth/casao/settings/environment-variables
   ```

2. **Generate CRON_SECRET**:
   ```bash
   openssl rand -base64 32
   ```

3. **Push to GitHub**:
   ```bash
   git push origin main
   ```

4. **Vercel auto-deploys** from GitHub

5. **Verify cron job** is enabled:
   ```
   https://vercel.com/huddlehealth/casao/settings/crons
   ```

## Cache Files

The `.cache` directory is gitignored except for:
- `guesty-token.json` - OAuth token (tracked for persistence)

Vercel will create:
- `availability.json` - Generated by cron
- `pricing.json` - Generated by cron

## Testing Locally

```bash
# Start dev server
npm run dev

# Manually trigger cache warmup
curl http://localhost:3002/api/warmup-cache

# Test cron endpoint (with secret)
curl -H "Authorization: Bearer YOUR_CRON_SECRET" http://localhost:3002/api/cron/cache-refresh
```

## Production URLs

- **Site:** https://casao.vercel.app (or your custom domain)
- **Cron logs:** Vercel dashboard → Deployments → Functions
- **Cache warmup:** https://casao.vercel.app/api/warmup-cache

## Monitoring

Check cron job execution:
1. Go to Vercel dashboard
2. Click on your project
3. Go to "Deployments" → "Functions"
4. Look for `/api/cron/cache-refresh` logs

## Troubleshooting

**Cron not running?**
- Check CRON_SECRET is set
- Verify cron is enabled in Vercel settings
- Check function logs for errors

**Cache not updating?**
- Check token is valid (not rate limited)
- Verify GUESTY credentials are correct
- Check API response logs

**Token rate limit hit?**
- Wait 24 hours
- Token cache persists across deployments
- Don't delete `.cache/guesty-token.json`
